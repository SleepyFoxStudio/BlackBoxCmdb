<h2>SQL View Data Loaded:</h2>



<div id="rowCount"></div>
<form id="filterForm">
    <fieldset id="formFields">
        <div>
            <label><input type="radio" name="view" class="columnToggle" value="Ec2" /> Ec2</label>
            <label><input type="radio" name="view" class="columnToggle" value="Accounts" /> Accounts</label>
            <label><input type="radio" name="view" class="columnToggle" value="SoftwareWithEc2" /> SoftwareWithEc2</label>
        </div>
        <button onclick="onBtnExport()">Download CSV export file</button>

    </fieldset>

</form>



<div id="myGrid" class="ag-theme-alpine" style="height: 400px; width: 100%;"></div>


<script>
    let gridInstance; // will hold the AG Grid instance


    function updateFilteredCount() {
      const filteredCount = gridInstance.getDisplayedRowCount();
      document.getElementById('rowCount').innerText =
        `Matching rows: ${filteredCount}`;
    }


    function fetchData() {
        document.getElementById('formFields').disabled = true;
        const gridDiv = document.querySelector('#myGrid');

        const payload = {
            View: getSelectedView()
        };

        // 1️⃣ Fetch data from your API first
        fetch("/api/SqlView", {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            })
            .then(res => {
                if (!res.ok) throw new Error("Failed to fetch grid data");
                return res.json();
            })
            .then(rowData => {
                // 2️⃣ Initialize grid with fetched data
                const gridOptions = {
                    onFilterChanged: updateFilteredCount,
                    onFirstDataRendered: updateFilteredCount,
                    onRowDataUpdated: updateFilteredCount,
                    columnDefs: rowData.Columns, // ✅ use the fetched data here,
                    defaultColDef: {
                        sortable: true,
                        filter: "agTextColumnFilter",
                        floatingFilter: true,
                    },
                    rowData: rowData.Data, // ✅ use the fetched data here
                    overlayLoadingTemplate: '<span class="ag-overlay-loading-center">Loading...</span>',
                    overlayNoRowsTemplate: '<span class="ag-overlay-loading-center">No data available</span>'
                };
                document.querySelector(`input[name="view"][value="${rowData.ViewName}"]`).checked = true;
                document.getElementById('formFields').disabled = false;
                // 3️⃣ Create the grid
                if (!gridInstance) {
                    gridInstance = new agGrid.createGrid(gridDiv, gridOptions);
                }
                else{
                    gridInstance.setGridOption("rowData", rowData.Data);
                    gridInstance.setGridOption("columnDefs", rowData.Columns);
                }
            });
    }


    document.addEventListener("DOMContentLoaded", function () {
        fetchData();
    });


    function onBtnExport() {
        gridInstance.exportDataAsCsv()
    }


    // Event listeners
    document.getElementById('filterForm').addEventListener('submit', e => {
        e.preventDefault();
        fetchData();
    });

    document.querySelectorAll('.columnToggle').forEach(cb => {
        cb.addEventListener('change', fetchData);
    });


    function getSelectedView() {
        const selected = document.querySelector('.columnToggle:checked');
        return selected ? selected.value : null;
    }

</script>