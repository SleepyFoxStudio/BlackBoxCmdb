<h2>Data Loaded:</h2>
@* <pre>@ViewData["DataJson"]</pre>
 *@



<div id="builder"></div>

<div>
    <label><input type="checkbox" class="columnToggle" value="Volume" /> Volume</label>
    <label><input type="checkbox" class="columnToggle" value="Disk" /> Disk</label>
    <label><input type="checkbox" class="columnToggle" value="Network" /> Network</label>
</div>

<form id="filterForm">
</form>


<div id="myGrid" class="ag-theme-alpine" style="height: 400px; width: 100%;"></div>


<script>
    let gridInstance; // will hold the AG Grid instance
    function fetchData() {
        const gridDiv = document.querySelector('#myGrid');

        const payload = {
            includeColumns: getSelectedColumns()
        };

        // 1️⃣ Fetch data from your API first
        fetch("/api/GetData/server", {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            })
            .then(res => {
                if (!res.ok) throw new Error("Failed to fetch grid data");
                return res.json();
            })
            .then(rowData => {
                // 2️⃣ Initialize grid with fetched data
                const gridOptions = {
                    columnDefs: rowData.Columns, // ✅ use the fetched data here,
                    defaultColDef: {
                        flex: 1,
                        sortable: true,
                        filter: true
                    },
                    rowData: rowData.Data, // ✅ use the fetched data here
                    overlayLoadingTemplate: '<span class="ag-overlay-loading-center">Loading...</span>',
                    overlayNoRowsTemplate: '<span class="ag-overlay-loading-center">No data available</span>'
                };

                // 3️⃣ Create the grid
                if (!gridInstance) {
                    gridInstance = new agGrid.createGrid(gridDiv, gridOptions);
                }
                else{
                    gridInstance.setGridOption("rowData", rowData.Data);
                    gridInstance.setGridOption("columnDefs", rowData.Columns);
                }
            });
    }


    document.addEventListener("DOMContentLoaded", function () {
        fetchData();
    });




    // Event listeners
    document.getElementById('filterForm').addEventListener('submit', e => {
        e.preventDefault();
        fetchData();
    });

    document.querySelectorAll('.columnToggle').forEach(cb => {
        cb.addEventListener('change', fetchData);
    });


    function getSelectedColumns() {
        return Array.from(document.querySelectorAll('.columnToggle:checked'))
                    .map(cb => cb.value);
    }

</script>